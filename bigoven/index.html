<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Proyecto BigOven</title>
        <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootswatch/4.3.1/simplex/bootstrap.min.css">
        <link href="//stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
        <style>
            select {
                height: 100px;
                resize: vertical;
                overflow: auto;
            }
            .loadinggif {
                display: block;
                margin: 10px auto;
                width: 48;
            }
        </style>
    </head>
    <body>

    <!-- navigation bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a href="?" class="navbar-brand">Proyecto BigOven <small>(beta)</small></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarColor02">
            <ul class="navbar-nav  ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="?about=1">Ayuda</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- about box -->
    <div id="aboutbox" class="alert alert-dismissible alert-primary m-2">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        Mini showcase de <i>BigOven</i> para explorar categorías (dietas)
    </div>

    <!-- content -->
    <div class="row m-1">
        <div class="col-sm-12 col-md-3 col-lg-2 p-1">
            <!-- tags -->
            <div class="card border-primary mb-2">
                <div class="card-header">1. Elija una etiqueta</div>
                <input id="filterleft" class="form-control-sm tagfilter" type="text" placeholder="Filtrar..">
                <select id="tagsleft" multiple=""></select>
                <p class="mt-0 mb-1 text-center"><small>(<i>Ctrl + clic</i> para seleccionar más)</small></p>
            </div>
            <p id="tagsjson"></p>
            <!-- form -->
            <div class="card border-info mt-2">
                <div class="card-header">2. Cree una dieta</div>
                <p class="mt-1 mb-0">Nombre:</p>
                <input name="name" class="form-control-sm" id="exampleInputPassword1" placeholder="(ej. Ovolactopescovegetariana)">
                <p class="mt-1 mb-0">¿Es inclusiva o exclusiva?</p>
                <select name="operator" class="form-control-sm" id="exampleSelect1">
                    <option value="" selected="selected">(no aplica)</option>
                    <option value="inclusive">inclusiva</option>
                    <option value="exclusive">exclusiva</option>
                </select>
                <p class="mt-1 mb-0">Comentarios:</p>
                <textarea name="comments" class="form-control-sm mb-1" rows="3" placeholder="(ej. huevo, #huevo, ovo)"></textarea>
                <button type="button" class="btn btn-info btn-md btn-block">Crear</button>
            </div>
        </div>
        <div class="col-sm-12 col-md-9 col-lg-10 p-1">
            <!-- diets -->
            <div class="list-group">
                <div class="list-group-item list-group-item-action active">Dietas</a>
            </div>
            <img id="dietsgif" class="loadinggif" src="https://cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif" loop="infinite" />
            <div id="diets" class="list-group mb-1"><p class="m-1">Sin resultados</p></div>
            <!-- recipes -->
            <div class="list-group">
                <div class="list-group-item list-group-item-action active">Recetas</a>
            </div>
            <img id="resultsgif" class="loadinggif" src="https://cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif" loop="infinite" />
            <div id="results" class="list-group mb-1"><p class="m-1">Sin resultados</p></div>
        </div>
    </div>

<script type="text/javascript">

// Read URL parameters
$.urlParam = function (name) {
  var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.search);
  return (results !== null) ? decodeURI(results[1]) || 0 : false;
}
// Ajax errors handler
$.ajaxError = function(jqxhr, textStatus, error) {
  var err = textStatus + ", " + error;
  console.log("Request Failed: " + err);
}

// DocumentReady
$(function() {

    //// init
    $('.loadinggif').hide();
    $(".filter").val("");
    // if about undefined
    if ($.urlParam('about') == 0)
        $('#aboutbox').hide();

    //// ajax
    // fetching initial tags
    $.getJSON("api/tags/")
    .done(function(result) {
        // iterating through results
        $.each(result, function(i, field) {
            // populating tagsleft
            var tagDisplay = field.Tag;
            if (tagDisplay.length > 20)
                tagDisplay = tagDisplay.substring(1, 20) + "..";
            $("#tagsleft").append('<option value="' + field.Tag + '">' + tagDisplay + ' (' + field.c + ')</option>');
        });
    })
    .fail($.ajaxError);

    // tags listener
    $("#tagsleft").on('change', function() {
        // clearing and showing gifs
        $("#results, #diets").empty();
        $('#resultsgif, #dietsgif').show();
        // creating JSON object from select
        var tags1 = $('#tagsleft').val();
        // showing selection to user
        $("#tagsjson").text(tags1.join(", "));
        // encoding for http
        tags1 = tags1.map(x => encodeURIComponent(x));
        var postBody = 'tags=' + JSON.stringify({ tags1 });

        // recipes
        $.post("api/recipes/", postBody, function(result) {
            $('#resultsgif').hide();
            //iterating through results
            if (result.length == 0) {
                $("#results").append('<p class="m-1">Sin resultados</p>');
            }
            $.each(result, function(i, field) {
                // populating results
                $htmlblock = `
                <div class="card">
                    <div class="row no-gutters">
                      <div style="max-width: 140px;">
                        <img src="https://bigoven-res.cloudinary.com/image/upload/t_recipe-256/${field.PhotoUrl}" class="card-img">
                      </div>
                      <div class="col">
                            <div class="card-body">
                                <a href="https://www.bigoven.com/recipe/r/${field.Id}" target="_blank">
                                    <h5 class="mb-1">${field.Title}</h5>
                                </a>
                                <p class="mb-1"><i class="fa fa-hand-o-right" aria-hidden="true"></i> ${field.PrimaryIngredient}</p>
                                <p class="mb-1"><i class="fa fa-heartbeat" aria-hidden="true"></i> ${field.FavoriteCount} | <i class="fa fa-star" aria-hidden="true"></i> ${field.StarRating} <small>(${field.ReviewCount})</small> | <i class="fa fa-thermometer-half" aria-hidden="true"></i> ${field.TotalCalories} Cal. | <i class="fa fa-users" aria-hidden="true"></i> ${field.Servings}</p>
                                <small>${field.Ingredients}</small>
                            </div>
                      </div>
                    </div>
                </div>`;
                $("#results").append($htmlblock);
            });
        }, 'json')
        .fail($.ajaxError);

        // diets

    });

    //// filters
    $("#filterleft").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#tagsleft option").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });

});
</script>

    </body>
</html>